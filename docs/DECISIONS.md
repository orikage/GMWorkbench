# DECISIONS

## 2025-10-11: 初期構成方針
- Vite + Vanilla JS を採用し、依存を最小限に抑える。
- テストは Vitest + jsdom を基盤とし、UIロジックをモジュール化して検証可能にする。
- ワークスペース UI は 1ファイル=1責務の原則に従い、`workspace.js` に初期骨格を集約。

## 2025-10-11: PDF入力の扱い
- ドラッグ＆ドロップとボタン選択の両対応とし、単一の受け口でファイル取得を担う。
- ファイル選択結果は `workspace:file-selected` カスタムイベントで上位へ通知し、副作用を分離。
- UI強調はクラス操作に限定し、後続の状態管理と競合しないよう純粋関数で組み立てる。

## 2025-10-11: 取り込みファイルキューの可視化
- PDFの投入状況を即時で把握できるよう、ドロップゾーン直下に一覧を常設する。
- ビューの責務を単純化するため、キューはイベントを受け取るだけの受動的DOMとして実装する。
- ファイルサイズはローカルで計算し、将来のダウンロード管理やキャッシュ検証の土台とする。

## 2025-10-11: 取り込みキューからの配置要求
- キュー項目には「ワークスペースに置く」アクションを設け、クリックで `workspace:file-open-request` を発火させる。
- イベント経由でウィンドウ生成処理へ橋渡しすることで、UIと描画ロジックの結合度を下げる。
- ファイルオブジェクトを直接渡し、後続工程での読み込みやキャッシュ判断に再利用できるようにする。

## 2025-10-11: 取り込みキューの削除操作
- GMの意図しない投入を即座に取り消せるよう、各項目に削除ボタンを常設する。
- 削除操作は `workspace:file-queue-remove` イベントで上位へ伝播させ、外部ロジックが後処理を差し込めるようにする。
- UIは削除後に空状態へ戻すことで「片付けた」感覚を可視化し、デスク比喩の快適さを守る。

## 2025-10-11: テスト実行モードの見直し
- CI でも確実に完走するよう、`pnpm test` はウォッチモードではなく単発実行に固定する。
- 開発時の継続実行が必要な場合は `vitest` コマンドを直接利用し、スクリプトは再現性を優先する。
- テスト終了を保証することで、将来的な自動化パイプラインでも手動操作を必要としない体験を担保する。

## 2025-10-11: PDFウィンドウのプレースホルダー
- `workspace:file-open-request` を受けた時点で仮想デスク上にPDFウィンドウを生成し、将来のビューワ実装の足場を整える。
- 閉じる操作は `workspace:window-close` イベントで通知し、外部ロジックがリソース解放や状態更新をフックできるようにする。
- ビューワ未搭載の段階でも「資料を置く／片付ける」体験を先に提供し、GMの作業フローを早期から検証可能にする。

## 2025-10-11: PDF.js ビューア統合
- `pdfjs-dist` を採用し、ブラウザ内だけでページ描画を完結させることでローカルファーストの原則を維持する。
- Vite では `pdf.worker.min.mjs?url` を読み込み、ビルド時にワーカーを自動バンドルする方針とする。
- 描画キャンバスは `data-*` 属性にページ番号・倍率・総ページ数を同期し、UI テストやアクセシビリティ計測から状態を取得できるようにする。
- ページ変更とズーム変更のイベント詳細に `totalPages` と `page` を含め、外部ロジックが描画完了前でも状態を正しく判断できるようにする。
- Vitest では pdf.js をモックし、`File#arrayBuffer` 非対応環境でも `Response` フォールバックで読み込みを再現できるようにした。

## 2025-10-11: ウィンドウのドラッグ移動と前面制御
- 仮想デスク上の窓をヘッダーのドラッグで移動できるようにし、紙資料を手で動かす直感を担保する。
- ウィンドウを選択した際は最前面へ自動で持ち上げ、視線の主従関係を維持する。
- DOM操作のみで完結するドラッグ実装とし、外部依存なしでテスト可能なロジックに留める。

## 2025-10-11: ウィンドウのリサイズ操作
- GMが参照領域を柔軟に確保できるよう、右下にリサイズハンドルを常設する。
- サイズ操作はマウスドラッグのみで完結させ、最小幅/高さを設けて可読性を損なわないようにする。
- リサイズ中もドラッグ移動ロジックを再利用し、イベントリスナーは作成時に束ねてテスト可能なままとする。

## 2025-10-11: ウィンドウのピン留め制御
- 重要資料を常に視界に置けるよう、各ウィンドウにピン留めトグルを設けて最前面固定を担保する。
- ピン操作は `workspace:window-pin-toggle` イベントで外部へ通知し、永続化や分析のフックポイントを確保する。
- ピン状態は通常ウィンドウより高い z-index カウンターで管理し、操作順に依存せず常に前面に残るよう制御する。

## 2025-10-11: ウィンドウ位置とサイズのキャンバス制御
- 仮想デスク外にはみ出さないよう、ドラッグとリサイズの座標をキャンバス領域内でクランプする。
- レイアウトエンジン非依存でもテストできるよう、キャンバス寸法にフォールバック値を設けてロジックを安定化させる。
- サイズ変更時は利用可能領域を再計算し、ピン留め状態でも位置調整が破綻しないよう同一のクランプ処理を共有する。

## 2025-10-11: ページ操作 UI の方針
- PDF ビューアを実装する前段階としてもページ操作体験を提供するため、各ウィンドウにページ入力フォームとナビゲーションボタンを常設する。
- ページ変更は `workspace:window-page-change` イベントで通知し、描画ロジックや永続化層が後からでもフックできるようにする。
- 入力値は 1 始まりの整数へ正規化し、空欄は現状維持として扱うことで誤入力時のテンポ低下を防ぐ。

## 2025-10-11: ページ操作のキーボード対応
- マウスを離しても参照テンポを維持できるよう、ウィンドウ本体にフォーカスで左右キーによるページ移動を割り当てる。
- フォーム要素の操作性を損なわないよう、入力欄やボタンにフォーカスしている場合はショートカットを抑制する。
- フォーカス移動時にウィンドウを前面に押し出し、視線の優先度とショートカット対象が一致する状態を維持する。

## 2025-10-11: 表示倍率コントロールの実装
- 実際のPDF描画前でも操作フローを検証できるよう、ウィンドウに倍率調整UIを先行して配置する。
- 50%〜200%の範囲で段階的に拡大縮小し、`workspace:window-zoom-change` イベントで描画層へ通知できるようにする。
- リセット操作を用意し、緊急時でも 100% 表示に即座に戻せることで GM の認知負荷を抑える。

## 2025-10-11: プレースホルダー表示の情報量
- ビューア未実装の期間でも操作結果を視覚的に確認できるよう、ウィンドウプレースホルダーへページ番号と倍率を反映する。
- `data-page` / `data-zoom` 属性を付与し、外部モジュールやテストから状態を直接参照できるようにする。
- メッセージ文言を動的に更新し、将来 PDF 描画へ差し替えた際もフィードバックの意図が維持されるようにする。
