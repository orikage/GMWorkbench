# GMWorkbench サイトマニュアル

GMWorkbench は TRPG GM が PDF シナリオを複数ウィンドウで並べ、メモや検索をしながら素早く参照するためのブラウザアプリです。本書ではブラウザ版 (http://gmworkbench.orikage.com/) の使い方を、初めて開いた直後の操作から日常利用時のメンテナンスまで順を追って説明します。

## 1. 基本情報
- **対応ブラウザ**: Chromium 系最新、Firefox ESR、Safari 16 以降を想定しています。
- **ネットワーク要件**: アプリはローカル優先設計で、PDF の処理・セッション保存ともにブラウザ内で完結します。外部へ PDF を送信する通信は発生しません。
- **保存場所**: ウィンドウ配置やメモは IndexedDB に自動保存され、次回アクセス時に復元されます。ブラウザのサイトデータ削除を行うと初期化されます。

## 2. 画面構成の概要
アプリは大きく「ワークスペース」「メニュー」「補助パネル」の 3 エリアで構成されています。

### 2.1 アプリバー
画面上部のアプリバーにはシナリオ切り替えボタンとアクティブウィンドウのステータス表示、レイヤー／資料／設定といったユーティリティボタンが並びます。これらは将来の拡張を見据えたアクセスポイントで、現在はステータスの確認とクイックメモへの導線として機能します。

### 2.2 ワークスペース (キャンバス)
中央のキャンバスには開いた PDF ウィンドウが重ねて表示されます。ウィンドウごとにページ・ズーム・回転・メモ・ブックマークなどの状態が保持され、複数の PDF を同時に並べ替えながら参照できます。

### 2.3 サイドメニュー
右側のメニューには 4 つのパネルが切り替え表示されます。

| メニュー | 役割 |
| --- | --- |
| **PDFブラウザ** | PDF の取り込みとキュー管理を行う基本パネルです。|
| **NPCノート** | クイックメモパネルと説明文をまとめています。後述のメモウィンドウを即座に開くショートカットです。|
| **マップビュー** | 今後の拡張予定を知らせる案内が表示されます。|
| **ログ** | 保存データの書き出し／読み込み／キャッシュ削除を行うメンテナンス機能をまとめています。|

## 3. 初回ガイドとサンプル PDF
初めて PDF を開く前はキャンバスにオンボーディングガイドが表示されます。手順に沿って操作の流れを確認でき、次のようなボタンを利用できます。

- **サンプルPDFを開いてみる**: 用意されたサンプル PDF を読み込み、検索語やアウトライン付きで主要機能を体験できます。
- **ガイドを閉じる**: 次回以降オンボーディングを表示しない設定に切り替えます。後から PDF を開き直すと自動的に非表示になります。

## 4. PDFブラウザパネルの使い方
### 4.1 PDF の取り込み
- 「PDFをドラッグ＆ドロップ、または下のボタンから選択してください。」と書かれたドロップゾーンにファイルを放り込むか、**PDFを開く** ボタンからファイル選択ダイアログを開きます。
- 複数ファイルを一度に選べ、選択後は `workspace:file-selected` イベントでキューへ渡されます。

### 4.2 取り込みキュー
- 選択した PDF は「取り込んだPDF」リストに並びます。ファイル名とサイズが表示され、必要なときに **ワークスペースに置く** ボタンでキャンバスへ配置します。
- キューから不要なファイルは **取り消す** ボタンで削除できます。キューが空になると「まだPDFは選択されていません。」のメッセージに戻ります。

## 5. PDFウィンドウの操作
### 5.1 基本操作
- キューから配置した PDF はキャンバス上に独立したウィンドウとして開きます。開いた順に重なり、ウィンドウをクリックすると前面に移動します。
- ヘッダー右上の **✕** ボタンでウィンドウを閉じると、対応するセッション情報も削除されます。閉じた内容はメンテナンスで読み込まない限り復元されません。
- ウィンドウは位置とサイズを調整でき、配置は自動保存されます。最大化状態やピン留め状態も保持され、再読み込み後に同じレイアウトへ戻ります。

### 5.2 ヘッダーのアクション
各ウィンドウのヘッダーには次の操作がまとまっています。

| ボタン | 説明 |
| --- | --- |
| **ピン留め** | ウィンドウを最前面に固定し、他のウィンドウを操作しても重なり順が崩れにくくします。|
| **複製** | 現在のページ・ズーム・回転・ピン状態を引き継いだ新しいウィンドウを生成し、元の位置から 24px ずらして積み重ねます。|
| **名称変更** | タイトルを編集できます。確定すると永続化され、ARIA ラベルやイベントにも反映されます。|
| **色** | 標準 → 琥珀 → 翡翠 → 紅玉 → 藍の順にカラータグを切り替え、視覚的な分類に使えます。|
| **最大化** | キャンバス全体へ広げて集中表示します。再度押すと元のサイズへ戻り、レイアウト情報は永続化されます。|
| **閉じる** | ウィンドウを閉じ、関連データを削除します。|

### 5.3 ページ操作と履歴
ツールバー左側にはページ操作がまとまっています。

- **ページ番号入力**と **⏮ / ⏭ / − / ＋** ボタンで直接ジャンプや前後移動が可能です。
- 表示したページは最大 50 件まで履歴に保存され、**戻**/**進** ボタンで履歴を辿れます。履歴位置はウィンドウ属性とイベントで公開され、永続化対象です。
- ページスライダーは総ページ数が判明している PDF で利用でき、ドラッグで高速移動できます。

### 5.4 ズームと回転
ツールバー右側では倍率と角度を調整できます。

- **縮小 / 拡大 / 100%** ボタンで 50%〜200% の範囲をステップ操作。ショートカット `-`, `=`, `0` も有効です。
- **幅合わせ / 全体表示** でウィンドウ幅または全体が収まる倍率を自動計算し、現在のフィット状態は `data-zoom-fit-mode` に反映されます。
- **↺ / ↻ / 0°** ボタンで 90° 単位の回転とリセットができ、角度は永続化されます。

### 5.5 ブックマークとナビゲーション
- ツールバーには **このページを記憶** ボタンとブックマーク一覧があり、最大 50 件まで登録できます。`b` キーでも追加可能です。
- ブックマーク一覧からページへジャンプすると `workspace:window-bookmark-jump` が発火し、隣接するブックマークへは `,` / `.` キーで移動できます。

### 5.6 メモとノート
- ウィンドウ下部にメモ欄があり、シーンの補足を保存できます。文字数は `data-notes-length` に同期され、内容は永続化されます。
- NPC ノートメニューから開ける **クイックメモ** ボタンを押すと、プレースホルダー付きのメモウィンドウが別途開きます。

### 5.7 PDF 内検索とアウトライン
- ウィンドウ内の検索フォームでキーワード検索が行えます。検索結果はリストと「前へ / 次へ」ボタンで巡回でき、ヒット件数はウィンドウ属性に公開されます。
- PDF にアウトライン（目次）が含まれている場合はサイドパネルに自動表示され、クリックで該当ページへ移動します。取得失敗時はステータスにエラーメッセージが表示されます。

### 5.8 フォーカス操作とショートカット
- `]` / `[` キーで最近使用した順にウィンドウのフォーカスを循環できます。フォーカス状態は `workspace__window--active` クラスとタイムスタンプに反映されます。
- 他にも `Home` / `End`、矢印キーによるページ移動などのショートカットをサポートしています。入力欄にフォーカスしている場合は誤操作防止のため無効化されます。

## 6. メンテナンス (ログパネル)
ログメニューにはセッション管理がまとまっています。

### 6.1 書き出しオプション
- **保存済みすべて** / **開いているウィンドウのみ** のどちらかを選び、必要に応じて **gzip 形式で圧縮する** チェックボックスを有効にします。
- **セッションを書き出す** ボタンで JSON (または JSON.GZ) ファイルがダウンロードされ、ウィンドウ件数とファイル名がステータスに表示されます。

### 6.2 セッション読み込み
- **セッションを読み込む** ボタンから JSON / JSON.GZ ファイルを選択すると、保存されていたウィンドウが再構築されます。読み込み後は最後にフォーカスしていたウィンドウが自動で再選択されます。
- 読み込みが成功するとウィンドウ件数、失敗した場合はエラーメッセージがステータスに表示されます。

### 6.3 キャッシュの全削除
- **キャッシュを全削除** ボタンで IndexedDB に保存された PDF とレイアウトをまとめて消去できます。確認ダイアログが表示され、実行後はウィンドウ数に応じたメッセージが表示されます。
- 削除後はオンボーディング状態がリセットされ、次回アクセス時にガイドが再表示されます。

## 7. データ保存とイベント通知
- ウィンドウを開く／閉じる／移動するたびに状態が IndexedDB に保存され、ブラウザを閉じてもレイアウトが再現されます。
- 主要操作は DOM カスタムイベントで通知されます。例: `workspace:session-exported`, `workspace:session-imported`, `workspace:window-zoom-change` など。外部スクリプトが必要な場合はこれらイベントを監視すると状態変化を検出できます。

## 8. トラブルシューティング
| 症状 | 対処 |
| --- | --- |
| PDF が読み込めない | ファイルが暗号化されていないか確認し、再度ドラッグ＆ドロップしてください。必要に応じてブラウザのコンソールでエラーを確認します。|
| 書き出しボタンが反応しない | 既に処理中でボタンが無効化されていないか確認し、ステータス欄のメッセージを参照してください。|
| 復元後にウィンドウが表示されない | 読み込み前にキャンバスへ既存ウィンドウが残っていた場合は自動で閉じられます。ブラウザのサイトデータが制限されていないか確認し、必要ならキャッシュを全削除して再読み込みしてください。|
| ショートカットが効かない | 入力欄にフォーカスしているとショートカットが無効化されます。キャンバスの空き領域や対象ウィンドウをクリックしてから再度試してください。|

## 9. 今後の更新
マップビューやユーティリティボタンは将来的な拡張を前提にしたプレースホルダーです。更新履歴や決定事項は `docs/changelog/` および `docs/decisions/` に追加されるため、最新情報はそれらを参照してください。

---
本マニュアルに追記すべき内容が見つかった場合は、新しいセクションを追加し、該当する変更を `docs/changelog/` に記録してください。
